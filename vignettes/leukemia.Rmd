---
title: "leukemia"
author: "Ruifeng Chen"
date: "2018/10/29"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
```

**Optimization**
One possible model for the life times is a Weibull distribution with density is:
$$f(t_i|\alpha_i,\gamma) = \frac{\gamma}{\alpha_i}(\frac{t_i}{\alpha_i})^{\gamma-1}exp(-(t_i/\alpha_i)^\gamma)$$

with $log\alpha_i = \beta_0+\beta_1x_i+\beta_2\mu_i$ where $x_i = log(WBC_i/10000)$

with $\mu_i = 1$ if the patient is AG positive and $\mu_i = 0$ if the patient is AG negative.

*(a)*
$$l(\beta_0,\beta_1,\beta_2,\delta) = log(\prod_if(t_i|\alpha_i,\gamma)) = nlog\gamma+(\gamma-1)\sum_ilogt_i-\gamma\sum_ilog\alpha_i-(\frac{t_i}{\alpha_i})^\gamma$$

Now with $\delta = \frac{1}{\gamma}$ and $z_i = (logt_i-\beta_0-\beta_1x_i-\beta_2\mu_i)/\delta$

We have that:
$$l(\beta_0,\beta_1,\beta_2,\delta) = -nlog\delta+\sum_i\gamma(logt_i-log\alpha_i)-\sum_ilogt_i-\sum_iexp(\gamma(logt_i-log\alpha_i))$$

after dropping additive terms constant in the parameters, we can write this as:
$$l(\beta_0,\beta_1,\beta_2,\delta) = -nlog\delta+\sum_i(z_i-exp(z_i))$$

*(b)*
The initial value for $\gamma$, $\beta_0$, $\beta_1$ and $\beta_2$ I chose are 1,2.5,-0.5 and 1 respectively. The results by three functions, "nlm", "optim" and "nlminb" are shown below
```{r, warning=FALSE}
library(MASS)
library(import)

x <- log(leuk$wbc/10000)
u<- ifelse(leuk$ag == "present",1,0)

Weibull.loglikelihood <- function(x){
  gam <- x[1]
  beta0 <- x[2]
  beta1 <- x[3]
  beta2 <- x[4]
  -(-dim(leuk)[1] * log(1/gam)+sum(gam * (log(leuk$time) - beta0 - beta1 * x - beta2 * u) - exp(gam * (log(leuk$time) - beta0 - beta1 * x - beta2 * u))))
}

Weibull.nlm <- nlm(Weibull.loglikelihood, c(1,2.5,-0.5,1), hessian = T)
err.nlm <- sqrt(diag(solve(Weibull.nlm$hessian)))

Weibull.optim <- optim(c(1,2.5,-0.5,1),Weibull.loglikelihood, hessian = T, method = "Nelder-Mead")
err.optim <- sqrt(diag(solve(Weibull.optim$hessian)))

Weibull.nlminb <- nlminb(c(1,2.5,-0.5,1),Weibull.loglikelihood, hessian = c(1,2.5,-0.5,1))
import::from("numDeriv", "hessian")
err.nlminb <- sqrt(diag(solve(hessian(Weibull.loglikelihood, Weibull.nlminb$par))))

Weibull.nlm.table <- data.frame(Weibull.nlm$estimate,err.nlm)
Weibull.optim.table <- data.frame(Weibull.optim$par,err.optim)
Weibull.nlminb.table <- data.frame(Weibull.nlminb$par,err.nlminb)

kable(Weibull.nlm.table)

kable(Weibull.optim.table)

kable(Weibull.nlminb.table)
```

*(c)*
From above three tables, we see that results by different functions are similar, so now we choose the result generated by function "optim" to check.

I generated 1000 different sets of parameters, with $\gamma$ in the range of 0.1 to 5, and all of $\beta_0$, $\beta_1$ and $\beta_2$ are in the range of -1 to 5. Then I calculate 1000 corresponding log likelihood. We can see all the 1000 values are larger than the estimate we got by "optim" function. So our estimate is pretty reasonable.
```{r, warning=FALSE}
Weibull.optim$par

gam.test <- c(seq(0.1,5,length=1000),Weibull.optim$par[1])
beta0.test <- c(seq(-1,5,length=1000),Weibull.optim$par[2])
beta1.test <- c(seq(-1,5,length=1000),Weibull.optim$par[3])
beta2.test <- c(seq(-1,5,length=1000),Weibull.optim$par[4])

Weibull.test <- NULL

for(i in 1:length(gam.test)){
  Weibull.test[i] <- Weibull.loglikelihood(c(gam.test[i],beta0.test[i],beta1.test[i],beta2.test[i]))
}

which(Weibull.test == min(Weibull.test))
```

